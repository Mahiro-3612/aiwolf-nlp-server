# ゲームロジックの実装について

このドキュメントでは、ゲームロジックの実装について説明します。  
ここで指すゲームロジックとは、人狼ゲームのルールならびにその遂行に関わる処理全般を指します。  

## 人狼ゲームのルール

### 役職、陣営、種族

人狼ゲームには、以下の役職が存在します。

| 役職   | 英語名    | 陣営     | 種族 |
| ------ | --------- | -------- | ---- |
| 人狼   | WEREWOLF  | 人狼陣営 | 人狼 |
| 狂人   | POSSESSED | 人狼陣営 | 人間 |
| 占い師 | SEER      | 市民陣営 | 人間 |
| 騎士   | BODYGUARD | 市民陣営 | 人間 |
| 村人   | VILLAGER  | 市民陣営 | 人間 |
| 霊媒師 | MEDIUM    | 市民陣営 | 人間 |

市民陣営の英語名は `VILLAGER` 、人狼陣営の英語名は`WEREWOLF`です。  
種族の人間の英語名は `HUMAN` 、人狼の英語名は `WEREWOLF` です。

詳細な実装については、[role.go](../model/role.go)を参照してください。

### 人数

#### 5人ゲーム

| 役職   | 人数 |
| ------ | ---- |
| 人狼   | 1    |
| 狂人   | 0    |
| 占い師 | 1    |
| 騎士   | 0    |
| 村人   | 3    |
| 霊媒師 | 0    |

### フェーズの流れ

#### 囁きフェーズ

人狼のエージェント数が2未満であるため、スキップされます。  
人狼のエージェント数が2以上である場合は、以下の処理をします。

生存している人狼エージェントをランダムに並び替えた順列を作成します。  
`game.whisper.max_count.per_day` の回数まで以下の処理を繰り返します。  
&emsp;&emsp;順列の先頭から順にエージェントに対して、以下の処理を繰り返します。  
&emsp;&emsp;&emsp;&emsp;エージェントの `game.whisper.max_count.per_agent` の残り回数が0の場合は、スキップします。  
&emsp;&emsp;&emsp;&emsp;エージェントに `WHISPER` リクエストを送信します。  
&emsp;&emsp;&emsp;&emsp;エージェントからの `WHISPER` リクエストを受信します。  
&emsp;&emsp;&emsp;&emsp;エラーが発生した場合は、スキップ発言に置換します。 (スキップカウントの増加は行いません)  
&emsp;&emsp;&emsp;&emsp;スキップカウントが `game.skip.max_count` を超えた場合は、オーバー発言に置換します。  
&emsp;&emsp;&emsp;&emsp;発言がオーバーもしくはスキップではない場合は、スキップカウントをリセットします。  
&emsp;&emsp;&emsp;&emsp;発言がオーバーである場合は、残り回数を0に設定します。  
&emsp;&emsp;全エージェントの発言がオーバーである場合は、トークフェーズを終了します。

#### トークフェーズ

生存しているエージェント数が2未満であるため、スキップされます。
生存しているエージェント数が2以上である場合は、以下の処理をします。

生存しているエージェントをランダムに並び替えた順列を作成します。  
`game.talk.max_count.per_day` の回数まで以下の処理を繰り返します。  
&emsp;&emsp;順列の先頭から順にエージェントに対して、以下の処理を繰り返します。  
&emsp;&emsp;&emsp;&emsp;エージェントの `game.talk.max_count.per_agent` の残り回数が0の場合は、スキップします。  
&emsp;&emsp;&emsp;&emsp;エージェントに `TALK` リクエストを送信します。  
&emsp;&emsp;&emsp;&emsp;エージェントからの `TALK` リクエストを受信します。  
&emsp;&emsp;&emsp;&emsp;エラーが発生した場合は、スキップ発言に置換します。 (スキップカウントの増加は行いません)  
&emsp;&emsp;&emsp;&emsp;スキップカウントが `game.skip.max_count` を超えた場合は、オーバー発言に置換します。  
&emsp;&emsp;&emsp;&emsp;発言がオーバーもしくはスキップではない場合は、スキップカウントをリセットします。  
&emsp;&emsp;&emsp;&emsp;発言がオーバーである場合は、残り回数を0に設定します。  
&emsp;&emsp;全エージェントの発言がオーバーである場合は、トークフェーズを終了します。

#### 追放フェーズ

生存しているエージェントに対して、`VOTE` リクエストを送信します。

#### 占いフェーズ

生存している占い師に対して、`DIVINE` リクエストを送信します。

#### 護衛フェーズ

生存している騎士に対して、`GUARD` リクエストを送信します。

#### 襲撃フェーズ

生存している人狼に対して、`ATTACK` リクエストを送信します。

### ゲームの流れ

5人ゲームの場合を例に説明します。  
ゲームの設定は以下の通りです。

```yaml
game:
  agent_count: 5
  vote_visibility: false
  talk_on_first_day: true
  max_has_error_agents_ratio: 0.2
  talk:
    max_count:
      per_agent: 3
      per_day: 15
  whisper:
    max_count:
      per_agent: 3
      per_day: 15
  skip:
    max_count: 3
  vote:
    max_count: 1
  attack:
    max_count: 1
    allow_no_target: true
  timeout:
    action: 60s
    response: 90s
```

#### ゲームの開始 

全エージェントに対して、 `INITIALIZE` リクエストが送信します。

#### 0日目の昼の開始

全エージェントに対して `DAILY_INITIALIZE` リクエストが送信します。  
`game.talk_on_first_day` が `true` の場合は、囁きフェーズが開始します。  
トークフェーズが開始します。

#### 0日目の夜の開始

全エージェントに対して `DAILY_FINISH` リクエストが送信します。  
`game.talk_on_first_day` が `true` の場合は、囁きフェーズが開始します。  
占いフェーズが開始します。

#### 1日目の昼の開始

全エージェントに対して `DAILY_INITIALIZE` リクエストが送信します。  
トークフェーズが開始します。

#### 1日目の夜の開始

全エージェントに対して `DAILY_FINISH` リクエストが送信します。  
追放フェーズを開始します。  
占いフェーズを開始します。  
囁きフェーズを開始します。  
護衛フェーズを開始します。  
襲撃フェーズを開始します。